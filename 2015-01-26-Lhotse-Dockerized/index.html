<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>2015 01 26 Lhotse Dockerized - CodingBird</title>
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">

  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script>

  <style>
    body {font-size: 90%;}
    pre, code {font-size: 100%;}
    h3, h4, h5, h6 {color: #2980b9; font-weight: 300}
  </style> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> CodingBird</a>
        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
      <ul class="current">
    
        
            <li class="toctree-l1 ">
                <a class="" href="../2014-10-30-dse-docker-demo">2014 10 30 dse docker demo</a>
            </li>
        

    
        
            <li class="toctree-l1 ">
                <a class="" href="../2014-11-01-kubernetes-dsf-demo">2014 11 01 kubernetes dsf demo</a>
            </li>
        

    
        
            <li class="toctree-l1 ">
                <a class="" href="../2014-11-05-Kubernetes-REST-API">2014 11 05 Kubernetes REST API</a>
            </li>
        

    
        
            <li class="toctree-l1 ">
                <a class="" href="../2014-11-12-Demystifying-Flynn">2014 11 12 Demystifying Flynn</a>
            </li>
        

    
        
            <li class="toctree-l1 ">
                <a class="" href="../2014-11-22-jflynn-tryout">2014 11 22 jflynn tryout</a>
            </li>
        

    
        
            <li class="toctree-l1 ">
                <a class="" href="../2015-01-05-Docker-Era-Is-Coming">2015 01 05 Docker Era Is Coming</a>
            </li>
        

    
        
            <li class="toctree-l1 current">
                <a class="current" href=".">2015 01 26 Lhotse Dockerized</a>
            </li>
        

    
</ul>

      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="icon icon-reorder"></i>
        <a href=".."></a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    <li>2015 01 26 Lhotse Dockerized</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              <hr />
<p>layout: post
title: 全民拥抱Docker云--Lhotse系统经验分享
published: true</p>
<hr />
<h3 id="_1">前言</h3>
<p>“只要站在风口，猪也能飞起来”，这碗心灵鸡汤不知道激励了多少英雄豪杰踏上寻风口之路。而现如今，Docker这阵龙卷风呼啸来袭，更让众人生起迎风而上、直冲云霄的欲望。为了找到这风口，数据平台部开始全面拥抱Docker，基于多年的大数据集群管理经验，倾力打造DockerOnGaia云平台（简称<a href="http://km.oa.com/group/docker/articles/show/207094">Gaia云</a>），并动员将数平自身的核心系统<a href="http://km.oa.com/group/2430/articles/show/165306">Lhotse</a>、<a href="http://km.oa.com/group/597/articles/show/191455">Hermes</a>、<a href="http://km.oa.com/group/2430/articles/show/163736">Hive</a>、<a href="http://km.oa.com/group/3292/articles/show/175686">TRC</a>、<a href="http://km.oa.com/group/3292/articles/show/176743">TDBank</a>等全面接入Gaia云。</p>
<p>Lhotse系统作为先锋部队，经过一段时间的改造-验证-灰度，目前现网已经完全接入、稳定运营。本文旨在分享Lhotse接入Gaia云的一些经验与想法，抛砖引玉，期待更多的系统加入队伍，一起在Docker云中探索前行。</p>
<h3 id="_2">背景介绍</h3>
<p>Lhotse是一个大数据任务调度系统，从架构上看是典型的Master-Agent分布式架构，如下图所示，作为调度核心的Base统筹分配任务，交由对应类型的Runner执行：</p>
<p><img alt="Lhotse架构图" src="https://raw.githubusercontent.com/tragicjun/tragicjun.github.io/master/images/LhotseArch.png" /></p>
<p>到目前为止，Lhotse线上支持68种Runner，分别对应68种不同的任务类型，集群总机器数将近200台。面对这种复杂多样的系统环境，Lhotse接入Gaia云的核心诉求是<strong>自动化</strong>，通过自动化来提高运维效率。这体现在如下两个方面：</p>
<ol>
<li>
<p>机器操作取代人工操作，将复杂枯燥的工作（比如资源分配、程序部署）交给云平台处理。</p>
</li>
<li>
<p>通用实现取代重复实现，云平台将一些通用性的基础工作（比如进程监控、自动拉起）抽象成标准化服务，不必重复造轮子。</p>
</li>
</ol>
<p>下面我们将分别从部署、调度、容错、扩缩容及服务发现五个纬度来讨论Lhotse如何在Gaia云中获得自动化。</p>
<h3 id="_3">自动部署</h3>
<p>Lhotse部署遇到的最大难点在于，每个Runner类型所依赖的运行环境是有差异的。例如，Pig Runner需要机器上预装PigClient、Hadoop，而Compute Runner需要预装PLC。极端的情况是，68种Runner对应68种不同的运行环境依赖，且要在200台机器里交叉部署，还要保证各个运行环境完整一致，相互不受影响，这对运维来说是极大的挑战。</p>
<p>所幸的是，Docker正是为了解决此类问题而生的。我们将每个Runner及其运行环境build成一个Docker镜像，push到Gaia云的Registry(docker.oa.com)，通过Registry自动分发到集群的任意机器上。标准化的镜像分发将保证Runner的运行环境跑到哪里都是一致的，且不受其他环境的影响。</p>
<p><img alt="Lhotse镜像分发" src="https://raw.githubusercontent.com/tragicjun/tragicjun.github.io/master/images/LhotseRunnerImages.png" /></p>
<h3 id="_4">自动调度</h3>
<p>有了自动化部署，我们可以方便地将Base/Runner发布到集群的任意机器。但接下来的问题是，选择哪台机器在什么时候运行哪个程序——这是调度要解决的问题。</p>
<p>以前，Lhotse集群的调度都是人工静态处理，资源分配粒度只能到机器级别。这导致调度工作量大，资源利用率却不高。如下两图分别展示了各个Runner机器的CPU与内存利用率：</p>
<p><img alt="Lhotse CPU利用率" src="https://raw.githubusercontent.com/tragicjun/tragicjun.github.io/master/images/LhotseCPUUsage.png" /></p>
<p><img alt="Lhotse内存利用率" src="https://raw.githubusercontent.com/tragicjun/tragicjun.github.io/master/images/LhotseMemUsage.png" /></p>
<p>现在，得益于Gaia云强大的调度能力，Lhotse已经告别了人工资源分配的时代，完全达到调度的自动化。Gaia自动调度主要带来两个方面的收益：</p>
<ol>
<li>
<p>资源分配粒度细分到CPU与内存级别。Lhotse可以根据每个Runner的资源需求来设定具体的CPU个数、内存值。目前，Gaia正在规划支持磁盘、网络带宽等其他资源，实现更精细化的调度。</p>
</li>
<li>
<p>集群公平地与其他租户共享（租户可以是不同的系统，也可以是同一个系统内的不同模块）。目前，Lhotse与Hermes系统共享集群，在Gaia中通过树形队列来抽象租户层次，如下图所示，Lhotse租户与Hermes租户各自获得集群50%的资源，在Lhotse内部Base租户与Runner租户再按比例瓜分Lhotse的资源。这种多租户的资源调配，即实现了资源的合理利用，也保证了资源共享的公平性。</p>
</li>
</ol>
<p><img alt="Lhotse资源池划分" src="https://raw.githubusercontent.com/tragicjun/tragicjun.github.io/master/images/LhotseQueueHierarchy.png" /></p>
<h3 id="_5">自动容错</h3>
<p>如前文所言，Lhotse的Runner多达68种，任何一个Runner出错，都有可能影响大批的调度任务。因此，对于每个Runner的监控及出错处理至关重要。</p>
<p>以前，Lhotse通过自定义脚本来监控Runner进程，在发现错误的情况下自动重启或拉起。这种方式存在两点弊端：一是监控脚本本身也需要维护；二是只能做本机重启，无法跨机重试，对于机器挂掉的情况无能为力。</p>
<p>现在，借助Gaia云的自动容错机制，Lhotse从单机容错上升为集群容错，主要体现在两个层面：</p>
<ol>
<li>
<p>自动重试，包括本地重试和跨机重试。Gaia云对于机器宕机、进程异常退出、OutOfMemory等异常都可以做到自动重试告警，且重试次数可以自行设定，本地重试优先于跨机重试。对于有本地上下文信息的Runner，可以设定较高的本地重试次数，以尽量保证效率。</p>
</li>
<li>
<p>自动屏蔽，即黑名单机制。当机器失败达到预设的次数，将被推上黑名单，在一定的时间内对调度屏蔽，以尽量降低出错的影响，且对业务来说是透明的。</p>
</li>
</ol>
<h3 id="_6">自动扩缩容</h3>
<p>弹性资源分配是云计算的核心理念，它的存在是基于这样一个事实——大部分的系统都在某种程度上遵循着二八定律，即有20%的时间处于高峰期，承受成倍于其他时间的负载。</p>
<p>TODO</p>
<h3 id="_7">自动服务发现</h3>
<p>从前文的架构图上可以看到，Lhotse内部最基本的通讯路径是——Runner向Base上报心跳。在静态分配资源时代，Runner是通过写死IP的方式来发现Base。显然，这种方式在资源动态分配的Gaia云中不再可行，需要新的服务发现机制。</p>
<p>这种服务发现机制要满足两个需求：</p>
<ol>
<li>
<p>当服务发生迁移或者新的实例部署时，自动更新地址。</p>
</li>
<li>
<p>当有多个服务实例时，自动执行负载均衡。</p>
</li>
</ol>
<p>Gaia云为此采纳了基于“Etcd-Confd-HAProxy”的服务发现架构：Etcd作为服务地址的存储中心，HAProxy作为服务访问的代理中心，Confd则是连接前两者的纽带（具体实现可以参考<a href="http://km.oa.com/group/docker/articles/show/209851">《服务注册与发现：腾讯Docker云V0.4版本发布》</a>)。基于这种服务发现机制，Runner发现Base的过程如下图所示：</p>
<p><img alt="Lhotse工作流" src="https://raw.githubusercontent.com/tragicjun/tragicjun.github.io/master/images/LhotseServiceDiscovery.png" /></p>
<h3 id="_8">总结</h3>
<p>本文分享了Lhotse系统接入Gaia云，实现自动化运维的实践经验： 通过部署、调度自动化，释放了人工运维的压力；通过容错、服务发现自动化，避免了重复造轮子。</p>
<p>作为第一个抵达风口的“猪”，Lhotse乘风而起，扶摇直上云端里，吹响了全民拥抱Docker云的号角。我们会继续探索前行，为大部队开道点灯，后会有期。</p>

            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../2015-01-05-Docker-Era-Is-Coming" class="btn btn-neutral" title="2015 01 05 Docker Era Is Coming"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
    <!-- Copyright etc -->
    </p>
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
        
      <span><a href="../2015-01-05-Docker-Era-Is-Coming" style="color: #fcfcfc;">&laquo; Previous</a></span>
      <span style="margin-left: 15px"><a href="" style="color: #fcfcfc">Next &raquo;</a></span>
    </span>
</div>
</body>
</html>